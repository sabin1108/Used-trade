<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>게시판 목록</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>게시판 목록</h1>
    <nav>
      <button onclick="location.href='home.html'">홈</button>
      <button id="create-post-btn">게시판 작성하기</button> <!-- 작성 페이지로 이동 -->
    </nav>
    <div id="user-info" style="display: none;"> <!-- 기본적으로 숨김 -->
      <span id="username"></span>님 (<span id="student_num"></span>)
      <button id="logout-btn">로그아웃</button>
    </div>
  </header>
  <main>
    <h2>게시판 목록</h2>
    <input type="text" id="search-input" placeholder="검색어를 입력하세요">
    <button id="search-btn">검색</button>
    <ul id="posts-list">
      <!-- 게시글 목록이 여기 표시됨 -->
    </ul>
  </main>

  <script src="board.js"></script>
  <script>
    // 게시글 목록 표시하는 함수
    function loadPosts(searchKeyword = '') {
      const posts = JSON.parse(localStorage.getItem('posts')) || [];
      const postsList = document.getElementById('posts-list');
      postsList.innerHTML = '';

      // 검색어 필터링
      const filteredPosts = posts.filter(post => 
        post.title.includes(searchKeyword) ||
        post.bookTitle.includes(searchKeyword) ||
        post.author.includes(searchKeyword) ||
        post.publisher.includes(searchKeyword) ||
        post.lectureName.includes(searchKeyword)
      );

      filteredPosts.forEach((post, index) => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `
          <strong>${post.title}</strong>
          <p>책 제목: ${post.bookTitle}</p>
          <p>저자: ${post.author}</p>
          <p>출판사: ${post.publisher}</p>
          <p>강의명: ${post.lectureName}</p>
          <p>가격: ${post.price}원</p>
          <p>${post.content}</p>
          <button onclick="editPost(${index})">수정</button>
          <button onclick="deletePost(${index})">삭제</button>
          <button onclick="markAsSold(${index})">판매완료</button>
          <button onclick="startChat(${index})">1대1 채팅하기</button>
        `;
        postsList.appendChild(listItem);
      });
    }

    // 게시글 수정
    function editPost(index) {
      // 수정 로직을 구현합니다. 예를 들어, 별도의 수정 페이지로 이동할 수 있습니다.
      location.href = `edit-post.html?postIndex=${index}`;
    }

    // 게시글 삭제
    function deletePost(index) {
      const posts = JSON.parse(localStorage.getItem('posts')) || [];
      posts.splice(index, 1);
      localStorage.setItem('posts', JSON.stringify(posts));
      loadPosts();  // 목록을 다시 로드
    }

    // 게시글 판매완료 처리
    function markAsSold(index) {
      const posts = JSON.parse(localStorage.getItem('posts')) || [];
      posts[index].title = `[판매완료] ${posts[index].title}`;
      localStorage.setItem('posts', JSON.stringify(posts));
      loadPosts();  // 목록을 다시 로드
    }

    // 1대1 채팅 시작
    function startChat(index) {
      // 채팅 로직을 구현합니다. 예를 들어, 별도의 채팅 페이지로 이동할 수 있습니다.
      alert('1대1 채팅을 시작합니다.');
    }

    // 게시판 검색 기능
    document.getElementById('search-btn').addEventListener('click', function() {
      const searchKeyword = document.getElementById('search-input').value;
      loadPosts(searchKeyword);  // 검색어를 기준으로 게시글을 필터링하여 표시
    });

    // 사용자 정보를 서버에서 가져와 표시
    function loadUserInfo() {
      // 서버에서 사용자 정보를 가져옴 (가정: /api/profile에서 사용자 정보를 가져옴)
      fetch('/api/profile')
        .then(response => response.json())
        .then(data => {
          if (data && data.username) {
            document.getElementById('username').innerText = data.username;
            document.getElementById('student_num').innerText = data.student_num;
            document.getElementById('user-info').style.display = 'block'; // 사용자 정보 표시
          }
        })
        .catch(error => {
          console.error('사용자 정보를 불러오는 중 오류 발생:', error);
        });
    }

    // 로그아웃 처리
    document.getElementById('logout-btn').addEventListener('click', function() {
      fetch('/logout', { method: 'POST' })
        .then(response => {
          if (response.ok) {
            window.location.href = '/login.html';  // 로그아웃 후 로그인 페이지로 이동
          } else {
            console.error('로그아웃 실패');
          }
        })
        .catch(error => {
          console.error('로그아웃 중 오류:', error);
        });
    });

    // 게시판 작성하기 버튼 클릭 시 작성 페이지로 이동
    document.getElementById('create-post-btn').addEventListener('click', function() {
      location.href = 'create-post.html'; // 'create-post.html' 페이지로 이동
    });

    // 페이지 로드 시 게시글 목록과 사용자 정보 로드
    window.onload = function() {
      loadPosts();  // 게시글 목록 불러오기
      loadUserInfo();  // 사용자 정보 불러오기
    };
  </script>
</body>
</html>
